# 参考：

[外行人都能看懂的SpringCloud，错过了血亏！](https://segmentfault.com/a/1190000016157665)

[分布式系统的CAP理论](https://www.hollischuang.com/archives/666)

[分布式系统的BASE理论](https://www.hollischuang.com/archives/672)

[TOC]

# 一、集群，分布式，微服务，SOA

## 1、集群

> 计算机集群简称集群是一种计算机系统，它**通过一组松散集成的计算机软件和/或硬件连接起来高度紧密地协作完成计算工作。在某种意义上，他们可以被看作是一台计算机**。**集群系统中的单个计算机通常称为节点，通常通过局域网连接，但也有其它的可能连接方式**。集群计算机通常用来改进单个计算机的计算速度或可靠性。一般情况下集群计算机比单个计算机，比如工作站或超级计算机性能价格比要高得多

**集群技术特点**：

- 通过**多台计算机完成同一个工作**，达到更高的效率。
- **两机或多机内容、工作过程等完全一样**。如果一台死机，另一台也可用。

![image-20191231163159944](.\img\image-20191231163159944.png)

**举例**：

- 小周在公司写Java程序，但公司业务在发展，一个Java开发者可能**忙不过来**，小周有的时候也得**请个假呀**。于是请了3y过去**一起做Java开发**。平时小周和3y就写Java程序，但3y可能**有事**要回学校一趟。没事，公司还有小周做Java开发呢，公司开发还能继续运作。
  - 3y跟小周**都是做Java开发**。
  - 3y来了，小周的工作可以**分担**一些。
  - 3y请假了，还有小周在呢。

我写了一个910便利网发布到服务器去了，现在越来越多的人访问了，访问有点慢，怎么办？？？很简单，(只有充钱才能变强)，加配置吧(加cpu，加内存)。升级完配置之后，访问人数越来越多，于是发现又不禁用啦，在这台机器上加配置已经解决不了了，怎么办？？？很简单，(只有充钱才能变强)，我**再买一台服务器，将910便利网也发布到新买的这台服务器上去**。

特点：

- 这两台服务器都是运行**同一个系统**--->910便利网

好处：

- 本来只有一台机器处理访问，现在有两台机器处理访问了，**分担了压力**。
- 如果其中一台忘记缴费了，暂时用不了了。没关系，还有另一台可以用呢。

**总结：**

**同一个业务，部署在多个服务器上（不同的服务器运行同样的代码，干一样的事）；**

## 2、分布式

> 分布式系统是一组计算机，通过网络相互连接传递消息与通信后并协调它们的行为而形成的系统。**组件之间彼此进行交互以实现一个共同的目标**。

**举例**：

现在公司有小周和3y一起做Java开发，做Java开发一般jQuery，AJAX都能写一点，所以这些活都由我们来干。可是呢，3y对前端不是很熟，有的时候调试半天都调不出来。老板认为3y是真的菜！于是让小周**专门来处理前端**的事情。这样3y就高兴了，可以**专心写自己的Java**，前端就**专门**交由小周负责了。于是，小周和3y就变成了**协作开发**。

- 3y对前端不熟(能写出来)，但在调试的时候可能会花费很多时间
- 小周来**专门做前端**的事，3y可以**专心写自己的Java程序**了。
- 都是为了项目正常运行以及迭代。

我的910便利网已经部署到两台服务器去了，但是越来越多的人去访问。现在也逐渐承受不住啦。那现在怎么办啊？？那继续充钱变强？？作为一个理智的我，肯定得想想是哪里有问题。现在910便利网的模块有好几个，全都丢在同一个Tomcat里边。

其实**有些模块的访问是很低的(比如后台管理)**，那我可不可以这样做：**将每个模块抽取独立出来，访问量大的模块用好的服务器装着，没啥人访问的模块用差的服务器装着**。这样的好处是：一、**资源合理利用了**(没人访问的模块用性能差的服务器，访问量大的模块**单独提升性能**就好了)。二、**耦合度降低了**：每个模块独立出来，各干各的事(专业的人做专业的事)，便于扩展。

**特点**：

- 将910便利网的**功能拆分，模块之间独立**，在使用的时候再将这些**独立的模块组合起来**就是一个系统了。

**好处**：

- 模块之间独立，各做各的事，**便于扩展，复用性高**。
- **高吞吐量**。某个任务需要一个机器运行10个小时，将该任务用10台机器的分布式跑(将这个任务拆分成10个小任务)，可能2个小时就跑完了。

**总结：**

**一个系统拆分成多个子系统，部署在不同的服务器上（不同的服务器运行不同的代码，为了同一个目的）。**

## 3、集群/分布式

集群和分布式并不冲突，可以有**分布式集群**

现在3y的公司规模变大了，有5个小伙子写Java，4个小伙子写前端，2个小伙子做测试，1个小伙子做DBA。

- Java，前端，测试，DBA的关系看作是分布式的
- 5个Java看作是集群的(前端，测试同理)...

## 4、面向服务架构(SOA)

SOA（`Service Oriented Architecture`）面向服务的架构：**它是一种设计方法，其中包含多个服务， 服务之间通过相互依赖最终提供一系列的功能**。一个服务通常以独立的形式存在于操作系统进程中。各个服务之间 通过网络调用。
**SOA结构图**：

![image-20200101164739867](.\img\image-20200101164739867.png)

**ESB：**

> `ESB`（**企业服务总线**），简**单 来说`ESB`就是一根管道，用来连接各个服务节点。为了集成不同系统，不同协议的服务，`ESB`做了消息的转化解释和路由工作，让不同的服务互联互通**。

**ESB缺点：**

> 每个供应商提供的`ESB`产品有偏差，自身实现较为复杂；应用服务粒度较大，`ESB`集成整合所有服务和协议、数据转换使得运维、测试部署困难。所有服务都通过一个通路通信，直接降低了通信速度。

## 5、微服务

微服务是一个概念、一个项目开发的架构思想。`Spring Cloud` 是微服务架构的一种 Java 实现。

微服务架构模式（`Microservices Architecture Pattern`）的**目的是将大型的、复杂的、长期运行的应用程序构建为一组相互配合的服务**，每个服务都可以很容易得局部改良。 `Micro` 这个词意味着每个服务都应该足够小，但是，这里的小不能用代码量来比较，而应该是从业务逻辑上比较 —— 符合 [SRP 原则](https://en.wikipedia.org/wiki/Single_responsibility_principle)的才叫微服务。

关于微服务的一个形象表达：
![img](.\img\006tNc79ly1fqc291i8v8j30go0aygly.jpg)
X 轴：水平扩展，即在负载均衡服务器后增加多个运行实例
Z 轴：数据库的扩展，即分库分表
Y 轴：功能分解，即将不同职能的模块分成不同的服务

**微服务结构图**：

![image-20200101165450338](.\img\image-20200101165450338.png)

> `API Gateway`网关是一个服务器，是系统的唯一入口。为每个客户端提供一个定制的API。API网关核心是，**所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能。如它还可以具有其它职责，如身份验证、监控、负载均衡、缓存、请求分片与管理、静态响应处理**。通常，网关提供`RESTful/HTTP`的方式访问服务。而服务端通过**`服务注册中心进行服务注册和管理`**。

**微服务的特点：**

- **单一职责：**

  微服务中每一个服务都对应唯一的业务能力，做到**单一职责**

- **微：**

  微服务的**服务拆分粒度很小**，例如一个用户管理就可以作为一个服务。每个服务虽小，但五脏俱全。

- **面向服务：**

  面向服务是说每个服务都要对外暴露Rest风格服务接口API。并不关心服务的技术实现，做到平台与语言无关，也不限定用什么技术实现，只要提供Rest风格的接口即可。

- **自治：**自治是说服务间相互独立，互不干扰

  - 团队独立：每个服务都是一个独立的开发团队。
  - 技术独立：因为是面向服务，提供Rest接口，使用什么技术没有干扰。
  - 前后端分离：采用前后端分离开发，提供统一Rest接口，后端不用再为PC，移动端开发不同接口。
  - 数据库分离：每个服务都是使用自己的数据源。
  - 独立部署：服务间虽然有调用，但要做到服务重启不影响其他服务。有利于持续集尘和持续交互。每个服务都是独立的组件，可复用，可替换，降低耦合，易维护。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 

微服务架构与`SOA`都是对系统进行拆分；微服务架构基于`SOA`思想，**可以把微服务当做去除了`ESB`(中心化)的`SOA`。`ESB`是`SOA`架构中的中心总线**，设计图形应该是星形的，而**微服务是去中心化的分布式软件架构**。两者比较类似，但其实也有一些差别：

| 功能     | SOA                  | 微服务                         |
| -------- | -------------------- | ------------------------------ |
| 组件大小 | 大块业务逻辑         | 单独任务或小块业务逻辑         |
| 耦合     | 通常松耦合           | 总是松耦合                     |
| 管理     | 着重中央管理         | 着重分散管理                   |
| 目标     | 确保应用能够交互操作 | 易维护，易扩展，更轻量级的交互 |

## 6、分布式/微服务/SOA

- 分布式：**不同模块部署在不同服务器上**
  作用：分布式解决网站高并发带来问题

- 集群：**多台服务器部署相同应用构成一个集群**
  作用：通过负载均衡设备共同对外提供服务

- SOA：业务系统分解为多个组件，让每个组件都独立提供离散，自治，可复用的服务能力，通过服务的组合和编排来实现上层的业务流程
  作用：简化维护,降低整体风险,伸缩灵活

- 微服务：架构设计概念,各服务间隔离（分布式也是隔离）,自治（分布式依赖整体组合）其它特性(单一职责,边界,异步通信,独立部署)是分布式概念的更严格执行`SOA`到微服务架构的演进过程
  作用：各服务可独立应用，组合服务也可系统应用。

![这里写图片描述](.\img\20180111213152625.jpg)



# 二、分布式系统的CAP理论与BASE理论

## 1、CAP理论概述

CAP理论：一个分布式系统最多只能同时满足一致性（`Consistency`）、可用性（`Availability`）和分区容错性（`Partition tolerance`）这三项中的两项。

![Teorema-CAP-2](.\img\Teorema-CAP-2.png)

> 读者需要注意的的是，CAP理论中的CA和数据库事务中ACID的CA并完全是同一回事儿。两者之中的A都是C都是一致性(`Consistency`)。CAP中的A指的是可用性（`Availability`），而ACID中的A指的是原子性（`Atomicity`)，切勿混为一谈。

## 2、CAP定义

### 2.1、Consistency 一致性

> 一致性指“`all nodes see the same data at the same time`”，即更新操作成功并返回客户端完成后，所有节点在同一时间的数据完全一致，所以，一致性，说的就是数据一致性。

对于一致性，可以分为从客户端和服务端两个不同的视角。从客户端来看，一致性主要指的是多并发访问时更新过的数据如何获取的问题。从服务端来看，则是更新如何复制分布到整个系统，以保证数据最终一致。

- 一致性是因为有并发读写才有的问题，因此在理解一致性的问题时，一定要注意结合考虑并发读写的场景。

- 从客户端角度，多进程并发访问时，更新过的数据在不同进程如何获取的不同策略，决定了不同的一致性。

**三种一致性策略**

- 强一致性

  对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性。

- 弱一致性

  如果能容忍后续的部分或者全部访问不到，则是弱一致性。

- 最终一致性

  如果经过一段时间后要求能访问到更新后的数据，则是最终一致性（最终一致性是弱一致性的一种）。

`CAP`中，**不可能同时满足的这个一致性指的是强一致性**。

### 2.2、Availability 可用性

> 可用性指“`Reads and writes always succeed`”，即服务一直可用，而且是正常响应时间。

对于一个可用性的分布式系统，每一个非故障的节点必须对每一个请求作出响应。所以，一般我们在衡量一个系统的可用性的时候，都是通过停机时间来计算的。

|          可用性分类          | 可用水平（%） | 年可容忍停机时间 |
| :--------------------------: | :-----------: | :--------------: |
|          容错可用性          |    99.9999    |      <1 min      |
|          极高可用性          |    99.999     |      <5 min      |
| 具有故障自动恢复能力的可用性 |     99.99     |     <53 min      |
|           高可用性           |     99.9      |      <8.8h       |
|          商品可用性          |      99       |    <43.8 min     |

通常我们描述一个系统的可用性时，我们说淘宝的系统可用性可以达到5个9，意思就是说他的可用水平是99.999%，即全年停机时间不超过 `(1-0.99999)*365*24*60 = 5.256 min`，这是一个极高的要求。

好的可用性主要是指系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。一个分布式系统，**上下游设计很多系统如负载均衡、WEB服务器、应用代码、数据库服务器等，任何一个节点的不稳定都可以影响可用性。**

### 2.3、Partition Tolerance分区容错性

> 分区容错性指“`the system continues to operate despite arbitrary message loss or failure of part of the system`”，即分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性和可用性的服务。

分区容错性和扩展性紧密相关。在分布式应用中，可能因为一些分布式的原因导致系统无法正常运转。好的分区容错性要求能够使应用虽然是一个分布式系统，而看上去却好像是在一个可以运转正常的整体。**比如现在的分布式系统中有某一个或者几个机器宕掉了，其他剩下的机器还能够正常运转满足系统需求，或者是机器之间有网络异常，将分布式系统分隔为独立的几个部分，各个部分还能维持分布式系统的运作，这样就具有好的分区容错性**。

## 3、CAP的证明

![intro_thumb](.\img\intro_thumb.png)

如上图，是我们证明`CAP`的基本场景，网络中有两个节点N1和N2，可以简单的理解N1和N2分别是两台计算机，他们之间网络可以连通，N1中有一个应用程序A，和一个数据库V，N2也有一个应用程序B2和一个数据库V。现在，A和B是分布式系统的两个部分，V是分布式系统的数据存储的两个子数据库。

在满足一致性的时候，N1和N2中的数据是一样的，V0=V0。在满足可用性的时候，用户不管是请求N1或者N2，都会得到立即响应。在满足分区容错性的情况下，N1和N2有任何一方宕机，或者网络不通的时候，都不会影响N1和N2彼此之间的正常运作。

![scenario1_thumb](.\img\scenario1_thumb.png)

如上图，是分布式系统正常运转的流程，用户向N1机器请求数据更新，程序A更新数据库Vo为V1，分布式系统将数据进行同步操作M，将V1同步的N2中V0，使得N2中的数据V0也更新为V1，N2中的数据再响应N2的请求。

这里，可以定义N1和N2的数据库V之间的数据是否一样为一致性；外部对N1和N2的请求响应为可用行；N1和N2之间的网络环境为分区容错性。这是正常运作的场景，也是理想的场景，然而现实是残酷的，当错误发生的时候，一致性和可用性还有分区容错性，是否能同时满足，还是说要进行取舍呢？

作为一个分布式系统，它和单机系统的最大区别，就在于网络，现在假设一种极端情况，N1和N2之间的网络断开了，我们要支持这种网络异常，相当于要满足分区容错性，能不能同时满足一致性和响应性呢？还是说要对他们进行取舍。

![scenario2_thumb](.\img\scenario2_thumb.png)

假设在N1和N2之间网络断开的时候，有用户向N1发送数据更新请求，那N1中的数据V0将被更新为V1，由于网络是断开的，所以分布式系统同步操作M，所以N2中的数据依旧是V0；这个时候，有用户向N2发送数据读取请求，由于数据还没有进行同步，应用程序没办法立即给用户返回最新的数据V1，怎么办呢？

**有二种选择**

1. **牺牲数据一致性，保证可用性。响应旧的数据V0给用户；**
2. **牺牲可用性，保证数据一致性。阻塞等待，直到网络连接恢复，数据更新操作M完成之后，再给用户响应最新的数据V1。**

**这个过程，证明了要满足分区容错性的分布式系统，只能在一致性（`强一致性`）和可用性两者中，选择其中一个。**

## 4、CAP权衡

通过CAP理论及前面的证明，我们知道无法同时满足一致性、可用性和分区容错性这三个特性，那要舍弃哪个呢？

**我们分三种情况来阐述一下**。

1. ### CA without P

   **这种情况在分布式系统中几乎是不存在的。首先在分布式环境下，网络分区是一个自然的事实。因为分区是必然的，所以如果舍弃P，意味着要舍弃分布式系统。那也就没有必要再讨论CAP理论了**。这也是为什么在前面的CAP证明中，我们以系统满足P为前提论述了无法同时满足C和A。

   比如我们熟知的关系型数据库，如My Sql和Oracle就是保证了可用性和数据一致性，但是他并不是个分布式系统。一旦关系型数据库要考虑主备同步、集群部署等就必须要把P也考虑进来。

   其实，在CAP理论中。C，A，P三者并不是平等的，CAP之父在《Spanner，真时，CAP理论》一文中写到：

   > 如果说Spanner真有什么特别之处，那就是谷歌的广域网。Google通过建立私有网络以及强大的网络工程能力来保证P，在多年运营改进的基础上，在生产环境中可以最大程度的减少分区发生，从而实现高可用性。

   从Google的经验中可以得到的结论是，无法通过降低CA来提升P。要想提升系统的分区容错性，需要通过提升基础设施的稳定性来保障。

   所以，对于一个分布式系统来说。P是一个基本要求，CAP三者中，只能在CA两者之间做权衡，并且要想尽办法提升P。

2. ### CP without A

    如果一个分布式系统不要求强的可用性，即容许系统停机或者长时间无响应的话，就可以在CAP三者中保障CP而舍弃A。

   **一个保证了CP而一个舍弃了A的分布式系统，一旦发生网络故障或者消息丢失等情况，就要牺牲用户的体验，等待所有数据全部一致了之后再让用户访问系统。**

   设计成CP的系统其实也不少，其中最典型的就是很多分布式数据库，他们都是设计成CP的。在发生极端情况时，优先保证数据的强一致性，代价就是舍弃系统的可用性。如`Redis`、`HBase`等，还有分布式系统中常用的`Zookeeper`也是在CAP三者之中选择优先保证CP的。

   无论是像`Redis`、`HBase`这种分布式存储系统，还是像`Zookeeper`这种分布式协调组件。数据的一致性是他们最最基本的要求。一个连数据一致性都保证不了的分布式存储要他有何用？

   > `ZooKeeper`是个`CP`（一致性+分区容错性）的，即任何时刻对`ZooKeeper`的访问请求能得到一致的数据结果，同时系统对网络分割具备容错性。但是它不能保证每次服务请求的可用性，也就是在极端环境下，`ZooKeeper`可能会丢弃一些请求，消费者程序需要重新请求才能获得结果。**ZooKeeper是分布式协调服务，它的职责是保证数据在其管辖下的所有服务之间保持同步、一致。所以就不难理解为什么ZooKeeper被设计成CP而不是AP特性的了。**

3. ### AP wihtout C

    **要高可用并允许分区，则需放弃一致性。一旦网络问题发生，节点之间可能会失去联系。为了保证高可用，需要在用户访问时可以马上得到返回，则每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。**

    这种舍弃强一致性而保证系统的分区容错性和可用性的场景和案例非常多。前面我们介绍可用性的时候说到过，很多系统在可用性方面会做很多事情来保证系统的全年可用性可以达到N个9，所以，对于很多业务系统来说，比如淘宝的购物，12306的买票。都是在可用性和一致性之间舍弃了一致性而选择可用性。

    > 你在12306买票的时候肯定遇到过这种场景，当你购买的时候提示你是有票的（但是可能实际已经没票了），你也正常的去输入验证码，下单了。但是过了一会系统提示你下单失败，余票不足。这其实就是先在可用性方面保证系统可以正常的服务，然后在数据的一致性方面做了些牺牲，会影响一些用户体验，但是也不至于造成用户流程的严重阻塞。
    >
    > 但是，我们说很多网站牺牲了一致性，选择了可用性，这其实也不准确的。就比**如上面的买票的例子，其实舍弃的只是强一致性。退而求其次保证了最终一致性。也就是说，虽然下单的瞬间，关于车票的库存可能存在数据不一致的情况，但是过了一段时间，还是要保证最终一致性的。**

    对于多数大型互联网应用的场景，主机众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到N个9，即保证P和A，舍弃C（退而求其次保证最终一致性）。虽然某些地方会影响客户体验，但没达到造成用户流程的严重程度。

**适合的才是最好的**

上面介绍了如何CAP中权衡及取舍以及典型的案例。孰优孰略，没有定论，只能根据场景定夺，适合的才是最好的。

对于涉及到钱财这样不能有一丝让步的场景，C必须保证。网络发生故障宁可停止服务，这是保证CP，舍弃A。比如前几年支付宝光缆被挖断的事件，在网络出现故障的时候，支付宝就在可用性和数据一致性之间选择了数据一致性，用户感受到的是支付宝系统长时间宕机，但是其实背后是无数的工程师在恢复数据，保证数数据的一致性。

对于其他场景，**比较普遍的做法是选择可用性和分区容错性，舍弃强一致性，退而求其次使用最终一致性来保证数据的安全。这其实是分布式领域的另外一个理论——BASE理论**。

## 5、BASE理论

> eBay的架构师Dan Pritchett源于对大规模分布式系统的实践总结，在ACM上发表文章提出BASE理论，BASE理论是对CAP理论的延伸，**核心思想是即使无法做到强一致性（Strong Consistency，[CAP](http://www.hollischuang.com/archives/666)的一致性就是强一致性），但应用可以采用适合的方式达到最终一致性（Eventual Consitency）。**

BASE是指基本可用（`Basically Available`）、软状态（ `Soft State`）、最终一致性（ `Eventual Consistency`）。

## 6、BASE定义

### 6.1、基本可用（Basically Available）

**基本可用是指分布式系统在出现故障的时候，允许损失部分可用性，即保证核心可用。**

电商大促时，为了应对访问量激增，部分用户可能会被引导到降级页面，服务层也可能只提供降级服务。这就是损失部分可用性的体现。

### 6.2、软状态（ Soft State）

**软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据至少会有三个副本，允许不同节点间副本同步的延时就是软状态的体现**。`mysql replication`的异步复制也是一种体现。

### 6.3、最终一致性（ Eventual Consistency）

最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。

## 7、ACID和BASE的区别与联系

`ACID`是传统数据库常用的设计理念，追求强一致性模型。`BASE`支持的是大型分布式系统，提出通过牺牲强一致性获得高可用性。

`ACID`和`BASE`代表了两种截然相反的设计哲学

**在分布式系统设计的场景中，系统组件对一致性要求是不同的，因此ACID和BASE又会结合使用。**

# 三、服务调用方式

## 1、RPC和HTTP

无论是`微服务`还是`SOA`，都面临着服务间的远程调用。那么服务间的远程调用方式有哪些呢？

常见的远程调用方式有以下2种：

- **RPC**：`Remote Produce Call`远程过程调用；采用`C/S`模式，客户端发送请求，服务端响应，基于底层的协议，比如TCP/IP模式。工作在会话层。自定义数据格式，速度快，效率高。早期的`webservice`，现在热门的`dubbo`，都是`RPC`的代表。
- **Http：**`http`是**一种网络传输协议，基于`TCP`，工作在应用层，规定了数据传输的格式**。现在客户端浏览器
  与服务端通信基本都是采用`Http`协议，也可以用来进行远程服务调用。**缺点是消息封装臃肿，优势是对服务的提供和调用方没有任何技术限定，自由灵活，更符合微服务理念**。现在热门的`Rest`风格，就可以通过http协议来实现。

**区别：**

`RPC`的机制是根据语言的API（Language API）来定义的，而不是根据基于网络的应用来定义的。如果你们公司全部采用`Java`技术栈，那么使用`Dubbo`作为微服务架构是一个不错的选择。

相反，如果公司的技术栈多样化，而且你更青睐Spring家族，那么`Spring Cloud`搭建微服务是不二之选。在我们的项目中，会选择`Spring Cloud`套件，因此会使用Http方式来实现服务间调用。

## 2、Http客户端工具

既然微服务选择了`Http`，那么我们就需要考虑自己来实现对请求和响应的处理。不过开源世界已经有很多的http客户端工具，能够帮助我们做这些事情，例如：

- HttpClient
- OKHttp
- URLConnection

不过这些不同的客户端，API各不相同。而`Spring`也有对http的客户端进行封装，提供了工具类叫`RestTemplate`。

## 3、Spring的RestTemplate

`Spring`提供了一个`RestTemplate`模板工具类，对基于Http的客户端进行了封装，并且实现了对象与json的序列化和反序列化，非常方便。`RestTemplate`并没有限定Http的客户端类型，而是进行了抽象，目前常用的3种都有支持：

- HttpClient
- OKHttp
- JDK原生的URLConnection（默认的）

导入 资料\http-demo 工程；

![image-20200101213005540](.\img\image-20200101213005540.png)

![image-20200101213016080](.\img\image-20200101213016080.png)

![image-20200101213207060](.\img\image-20200101213207060.png)

![image-20200101213211678](.\img\image-20200101213211678.png)

已经在导入的项目中的 `HttpDemoApplication` 注册一个 `RestTemplate` 对象，可以在启动类位置注册：

```java
package com.itheima;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
public class HttpDemoApplication {
	public static void main(String[] args) {
    	SpringApplication.run(HttpDemoApplication.class, args);
 	}
    
  	@Bean
  	public RestTemplate restTemplate(){
      	return new RestTemplate();
 	}
}
```

启动`springboot`项目，在项目中的测试类中直接 `@Autowired` 注入：

```java
package com.itheima.test;
import com.itheima.pojo.User;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.web.client.RestTemplate;
@RunWith(SpringRunner.class)
@SpringBootTest
public class RestTemplateTest {
  @Autowired
  private RestTemplate restTemplate;
  @Test
  public void test(){
    //如果要测试需要启动spring boot项目，以便获取数据
    String url = "http://localhost/user/8";
    User user = restTemplate.getForObject(url, User.class);
    System.out.println(user);
 }
}
```

通过`RestTemplate`的`getForObject()`方法，传递`url`地址及实体类的字节码，`RestTemplate`会自动发起请求，接收响应，并且帮我们对响应结果进行反序列化。

![image-20200101213630275](.\img\image-20200101213630275.png)

















